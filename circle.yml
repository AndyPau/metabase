machine:
  timezone:
    America/Los_Angeles
  java:
    version:
      oraclejdk8
  python:
    version: 2.7.3
  node:
    version: 4.4.7
  services:
    - docker
dependencies:
  override:
    - sudo apt-get purge mongodb-org*
    - sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 7F0CEB10
    - echo "deb http://repo.mongodb.org/apt/ubuntu precise/mongodb-org/3.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-3.0.list
    - sudo add-apt-repository ppa:crate/stable -y
    - sudo apt-get update
    - sudo apt-get install -y mongodb-org crate
    # ulimit setting refused Crate service to start on CircleCI container - so comment it
    - sudo sed -i '/MAX_LOCKED_MEMORY/s/^/#/' /etc/init/crate.conf
    - sudo service mongod restart
    - sudo service crate restart
    - lein deps
    - pip install awscli==1.7.3
    - npm cache clean
    - npm install -g npm@2.15.9
    - mkdir plugins
    - wget --output-document=plugins/ojdbc7.jar $ORACLE_JDBC_JAR
    - wget --output-document=plugins/vertica-jdbc-7.1.2-0.jar $VERTICA_JDBC_JAR
database:
  post:
    # MySQL doesn't load named timezone information automatically, you have to run this command to load it
    - mysql_tzinfo_to_sql /usr/share/zoneinfo | mysql -u ubuntu mysql
test:
  override:
    - docker run --detach --publish 5433:5433 sumitchawla/vertica
    - sleep 10
    - ENGINES=h2,vertica lein test
deployment:
  master:
    branch: master
    commands:
      - ./bin/deploy-webhook $DEPLOY_WEBHOOK
